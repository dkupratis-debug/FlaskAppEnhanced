name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Validate tag matches project version
        run: |
          python - <<'PY'
          import os
          import tomllib
          from pathlib import Path
          
          data = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          version = data["project"]["version"]
          tag = os.environ["GITHUB_REF_NAME"]
          expected = f"v{version}"
          if tag != expected:
              raise SystemExit(
                  f"Tag/version mismatch: tag={tag!r}, pyproject version={version!r}, expected {expected!r}"
              )
          print(f"Release tag validated: {tag} matches pyproject version {version}")
          PY
      - name: Build distributions
        run: |
          python -m pip install --upgrade pip build
          python -m build
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz
