name: Monthly Recap Issue

on:
  schedule:
    - cron: "0 14 1 * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  recap:
    runs-on: ubuntu-latest
    steps:
      - name: Create monthly community recap issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const now = new Date();
            const since = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const title = `Monthly Community Recap (${now.toISOString().slice(0, 7)})`;

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: "open", per_page: 100
            });
            const openIssueCount = openIssues.filter((i) => !i.pull_request).length;
            const openPrCount = openIssues.filter((i) => !!i.pull_request).length;

            const recentRuns = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner, repo, per_page: 100
            });
            const latest10 = recentRuns.slice(0, 10);
            const latestFailures = latest10.filter((r) => r.conclusion && r.conclusion !== "success").length;

            const pulls = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: "all", sort: "updated", direction: "desc", per_page: 100
            });
            const recentPulls = pulls.filter((pr) => new Date(pr.created_at) >= since);
            const firstTimePrs = recentPulls.filter((pr) =>
              pr.author_association === "FIRST_TIMER" || pr.author_association === "FIRST_TIME_CONTRIBUTOR"
            ).length;
            const uniqueLearnerContributors = new Set(
              recentPulls
                .filter((pr) => !pr.user?.login?.endsWith("[bot]"))
                .map((pr) => pr.user?.login)
                .filter(Boolean)
            ).size;

            const body = [
              "# Monthly Community Recap",
              "",
              `Month: ${now.toISOString().slice(0, 7)}`,
              "",
              "## Snapshot",
              `- Open issues: ${openIssueCount}`,
              `- Open pull requests: ${openPrCount}`,
              `- Latest 10 workflow runs with non-success conclusion: ${latestFailures}`,
              `- First-time contributor PRs (last 30 days): ${firstTimePrs}`,
              `- Unique non-bot PR contributors (last 30 days): ${uniqueLearnerContributors}`,
              "",
              "## Review Checklist",
              "- [ ] Share one highlight from this month",
              "- [ ] Share one lesson learned",
              "- [ ] Pick one process improvement for next month",
              "- [ ] Confirm Start Here links are still current",
              "- [ ] Confirm security docs and issue templates are still accurate",
              "",
              "## Useful Links",
              `- Traffic: https://github.com/${owner}/${repo}/graphs/traffic`,
              `- Actions: https://github.com/${owner}/${repo}/actions`,
              `- Discussions: https://github.com/${owner}/${repo}/discussions`,
              `- Open Issues: https://github.com/${owner}/${repo}/issues`,
              "",
              "Use this issue as the monthly program log."
            ].join("\\n");

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ["learning"]
            });
